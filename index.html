<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joe Bart Face Expressions</title>
    <link rel="shortcut icon"
        href="https://yt3.googleusercontent.com/0xhaIMs1vajime_rQtgxv1dhugOuVBgXfdsSsvV2tMAO7GOvolfeuZ_TX5RETnBha287nlHL=s800-c-k-c0x00ffffff-no-rj"
        type="image/x-icon">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <header>
        <h1>Joe Bart Face Expressions <strong>(WIP)</strong></h1>
        <h2>by: <a href="https://discord.com/users/504881797427888138" target="_blank" class="glow">Word</a></h2>
        <p>This data is AI-generated. If you notice any inaccuracies, please report them. :)</p>
        <span>I'll update when I feel like it.</span>

        <div class="controls">
            <input type="text" id="searchInput" placeholder="Search by face ID, expression, or feature..." />
            <button id="reportBtn" class="btn-report">Report Incorrect Data</button>
        </div>
        <div id="twitch-embed" class="twitch-player"></div>
        <img src="https://yt3.googleusercontent.com/8vsKtRillaQeMF-8SlC6ts0z0qs2LUyHX_-qAMKATlTQWmH3sHL7-ErnQk3s49mXFN6MPsQC1g=w2120-fcrop64=1,00000000ffffffff-k-c0xffffffff-no-nd-rj"
            alt="joebart_banner">
    </header>

    <table>
        <thead>
            <tr>
                <th>Face ID</th>
                <th>Expression</th>
                <th>Description</th>
                <th>Features</th>
                <th>Cutout</th>
                <th>Source Videos</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

    <!-- Image Modal -->
    <div id="imageModal" class="modal">
        <span class="close" id="closeImage">&times;</span>
        <div class="modal-content">
            <img id="modalImg" src="" alt="Cutout Image">
        </div>
    </div>

    <!-- Video Modal -->
    <div id="videoModal" class="modal">
        <span class="close" id="closeVideo">&times;</span>
        <div class="modal-content" style="display:flex;flex-direction:column;align-items:center;">
            <iframe id="modalVideoFrame" allowfullscreen
                style="width:90vw;max-width:900px;height:60vh;border:none;"></iframe>
            <div id="videoThumbnails" style="display:flex;gap:5px;margin-top:10px;overflow-x:auto;"></div>
        </div>
    </div>

    <!-- Report Modal -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeReport">&times;</span>
            <h2>Report Incorrect Face Data</h2>
            <img id="reportCutout" src="" alt="Face Cutout" />
            <form id="reportForm">
                <label for="faceId">Face ID:</label>
                <input list="faceIds" id="faceId" placeholder="Type to search..." required>
                <datalist id="faceIds"></datalist>

                <label for="issueType">Issue Type:</label>
                <select id="issueType" required>
                    <option value="">Select issue type...</option>
                    <option value="Wrong Expression">Wrong Expression</option>
                    <option value="Wrong Features">Wrong Features</option>
                    <option value="Image Missing">Image Missing</option>
                    <option value="Other">Other</option>
                </select>

                <label for="comments">Additional Comments:</label>
                <textarea id="comments" rows="4"></textarea>

                <button type="submit">Submit Report</button>
            </form>
        </div>
    </div>
    <script src="https://player.twitch.tv/js/embed/v1.js"></script>

    <!-- Create a Twitch.Player object. This will render within the placeholder div -->
    <script type="text/javascript">
        new Twitch.Player("twitch-embed", {
            channel: "joe_bartolozzi"
        });
    </script>
    <script>
        const imageModal = document.getElementById('imageModal');
        const modalImg = document.getElementById('modalImg');
        const videoModal = document.getElementById('videoModal');
        const modalVideo = document.getElementById('modalVideo');
        const videoThumbnails = document.getElementById('videoThumbnails');
        const reportModal = document.getElementById('reportModal');

        function getYouTubeThumbnail(url) {
            const m = url.match(/(?:v=|\/)([a-zA-Z0-9_-]{11})/);
            return m ? `https://img.youtube.com/vi/${m[1]}/maxresdefault.jpg` : null;
        }

        async function loadData() {
            let data = localStorage.getItem('facesDataCache');
            if (data) data = JSON.parse(data);
            else {
                const res = await fetch('./data/expressions.json', { cache: "force-cache" });
                data = await res.json();
                localStorage.setItem('facesDataCache', JSON.stringify(data));
            }

            const tableBody = document.getElementById('tableBody');
            const datalist = document.getElementById('faceIds');

            const expressions = Object.fromEntries(data.expressions.map(e => [e.id, e]));
            const fragmentTable = document.createDocumentFragment();
            const fragmentOptions = document.createDocumentFragment();

            data.faces.forEach(face => {
                const expr = expressions[face.expression_id] || {};
                const cutout = face.images.find(img => img.type === 'cutout')?.path;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                <td>${face.id}</td>
                <td>${expr.label || face.expression_id}</td>
                <td>${expr.description || ''}</td>
                <td>${Object.entries(face.features).map(([k, v]) => `${k}: ${v}`).join('<br>')}</td>
                <td>${cutout ? `<img src="${cutout}" class="cutout" loading="lazy">` : ''}</td>
                <td><div class="video-carousel"></div></td>
            `;

                const carousel = tr.querySelector('.video-carousel');
                if (face.source_videos.length > 0) {
                    const first = face.source_videos[0];
                    const firstThumb = getYouTubeThumbnail(first);
                    if (firstThumb) {
                        const container = document.createElement('div');
                        container.className = 'video-wrapper';

                        const img = document.createElement('img');
                        img.src = firstThumb;
                        img.loading = "lazy";
                        img.onclick = () => openVideoGallery(face.source_videos, first);
                        container.appendChild(img);

                        if (face.source_videos.length > 1) {
                            const badge = document.createElement('div');
                            badge.className = 'video-badge';
                            badge.textContent = `+${face.source_videos.length - 1}`;
                            badge.onclick = () => openVideoGallery(face.source_videos, first);
                            container.appendChild(badge);
                        }
                        carousel.appendChild(container);
                    }
                }

                fragmentTable.appendChild(tr);

                const opt = document.createElement('option');
                opt.value = face.id;
                fragmentOptions.appendChild(opt);
            });

            tableBody.appendChild(fragmentTable);
            datalist.appendChild(fragmentOptions);
        }

        function closeAllModals() {
            imageModal.style.display = 'none';
            videoModal.style.display = 'none';
            reportModal.style.display = 'none';

            const modalVideoFrame = document.getElementById('modalVideoFrame');
            modalVideoFrame.src = '';
        }

        document.getElementById('closeImage').onclick = () => imageModal.style.display = 'none';
        imageModal.onclick = e => { if (e.target === imageModal) imageModal.style.display = 'none'; }

        function openVideoGallery(videos, currentUrl) {
            closeAllModals();

            const toEmbed = currentUrl.replace("watch?v=", "embed/");
            const modalVideoFrame = document.getElementById('modalVideoFrame');
            modalVideoFrame.src = toEmbed;

            videoThumbnails.innerHTML = '';

            videos.forEach(url => {
                const thumb = getYouTubeThumbnail(url);
                if (!thumb) return;
                const img = document.createElement('img');
                img.src = thumb;
                img.loading = "lazy";
                img.style.height = '50px';
                img.style.cursor = 'pointer';
                img.onclick = () => {
                    modalVideoFrame.src = url.replace("watch?v=", "embed/");
                };
                videoThumbnails.appendChild(img);
            });

            videoModal.style.display = 'flex';
        }


        document.getElementById('closeVideo').onclick = () => closeAllModals();
        videoModal.onclick = e => { if (e.target === videoModal) closeAllModals(); }

        document.getElementById('reportBtn').onclick = () => { closeAllModals(); reportModal.style.display = 'flex'; }
        document.getElementById('closeReport').onclick = () => reportModal.style.display = 'none';
        reportModal.onclick = e => { if (e.target === reportModal) reportModal.style.display = 'none'; }

        document.getElementById('tableBody').addEventListener('click', e => {
            if (e.target.classList.contains('cutout')) {
                modalImg.src = e.target.src;
                imageModal.style.display = 'flex';
                return;
            }
        });

        document.getElementById('searchInput').addEventListener('input', e => {
            const text = e.target.value.toLowerCase();
            document.querySelectorAll('#tableBody tr').forEach(tr =>
                tr.style.display = tr.textContent.toLowerCase().includes(text) ? '' : 'none'
            );
        });

        document.getElementById('reportForm').addEventListener('submit', async e => {
            e.preventDefault();
            const faceId = document.getElementById('faceId').value;
            const issueType = document.getElementById('issueType').value;
            const comments = document.getElementById('comments').value;
            const cutoutUrl = document.getElementById('reportCutout').src;

            const payload = {
                embeds: [{
                    title: 'Face Data Report',
                    color: 16711680,
                    fields: [
                        { name: 'Face ID', value: faceId },
                        { name: 'Issue Type', value: issueType },
                        { name: 'Comments', value: comments || 'None' }
                    ],
                    image: { url: cutoutUrl || '' },
                    timestamp: new Date()
                }]
            };

            await fetch('YOUR_WEBHOOK_HERE', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });

            reportModal.style.display = 'none';
            e.target.reset();
        });

        document.getElementById('tableBody').addEventListener('click', e => {
            const row = e.target.closest('tr');
            if (!row) return;

            if (
                e.target.classList.contains('cutout') ||
                e.target.closest('.video-carousel') ||
                e.target.closest('.video-wrapper') ||
                e.target.classList.contains('video-badge')
            ) {
                return;
            }

            const faceId = row.cells[0].textContent;
            const cutoutImg = row.querySelector('.cutout');

            document.getElementById('faceId').value = faceId;
            document.getElementById('reportCutout').src = cutoutImg ? cutoutImg.src : '';

            closeAllModals();
            reportModal.style.display = 'flex';
        });

        loadData();
    </script>

</body>

</html>